<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #f5f7fb;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        
        .nav-buttons {
            display: none;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-login {
            background: white;
            color: #4361ee;
        }
        
        .btn-signup {
            background: transparent;
            border: 2px solid white;
            color: white;
        }
        
        .btn-purple {
            background: #9b59b6;
            color: white;
        }
        
        /* Pages */
        .page {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .active-page {
            display: block;
        }
        
        /* Home Page */
        .home-hero {
            text-align: center;
            padding: 50px 20px;
            background: linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.9)), 
                        url('https://images.unsplash.com/photo-1516321318423-f06f85e504b3?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80');
            background-size: cover;
            border-radius: 10px;
        }
        
        .home-hero h1 {
            color: #3a0ca3;
            margin-bottom: 20px;
            font-size: 2.5rem;
        }
        
        .home-hero p {
            color: #555;
            margin-bottom: 30px;
            font-size: 1.2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .btn-track {
            background: #4361ee;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            cursor: pointer;
            margin-top: 20px;
        }
        
        /* Attendance Page */
        .date-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .current-date {
            font-size: 1.8rem;
            color: #4361ee;
            font-weight: bold;
        }
        
        .attendance-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .btn-present {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
        }
        
        .btn-absent {
            background: #f44336;
            color: white;
            padding: 10px 20px;
        }
        
        /* Calendar */
        .calendar-container {
            margin: 20px 0;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .calendar-nav-btn {
            background: #4361ee;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .day-header {
            text-align: center;
            padding: 10px;
            background: #f0f2f5;
            font-weight: bold;
            color: #4361ee;
        }
        
        .calendar-day {
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            background: #f8f9fa;
            cursor: pointer;
        }
        
        .calendar-day.today {
            border: 2px solid #4361ee;
            background: #e3f2fd;
        }
        
        .calendar-day.present {
            background: #e8f5e8;
            color: #4CAF50;
        }
        
        .calendar-day.absent {
            background: #ffebee;
            color: #f44336;
        }
        
        .calendar-day.holiday {
            background: #fff3e0;
            color: #ff9800;
        }
        
        .day-number {
            font-weight: bold;
        }
        
        .day-status {
            font-size: 0.7rem;
            margin-top: 2px;
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .percentage {
            color: #4361ee;
        }
        
        .present-count {
            color: #4CAF50;
        }
        
        .absent-count {
            color: #f44336;
        }
        
        /* Login Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        .modal h2 {
            color: #4361ee;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        /* Admin Panel */
        .admin-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .admin-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        /* Visualization Page */
        .visualization-page {
            background: #0a0e17;
            color: white;
            min-height: 70vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .attendance-ring {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 20px auto;
        }
        
        .ring-container {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #4cc9f0 0% 0%,
                #3a0ca3 0% 100%
            );
            box-shadow: 0 0 40px rgba(76, 201, 240, 0.7);
        }
        
        .ring-inner {
            position: absolute;
            width: 70%;
            height: 70%;
            border-radius: 50%;
            background: #0a0e17;
            top: 15%;
            left: 15%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .percentage {
            font-size: 3.5rem;
            font-weight: 800;
            color: #4cc9f0;
            text-shadow: 0 0 15px rgba(76, 201, 240, 0.7);
        }
        
        /* Date Range Selector */
        .date-range {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .date-range h3 {
            margin-bottom: 10px;
            color: #4361ee;
        }
        
        .date-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-inputs input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            margin-top: 20px;
        }
        
        .designer {
            color: #4361ee;
            font-weight: bold;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }
        
        .notification.success {
            background: #4CAF50;
        }
        
        .notification.error {
            background: #f44336;
        }
        
        .notification.info {
            background: #4361ee;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        /* Mobile Responsive Fixes */
@media (max-width: 768px) {
    header {
        flex-direction: column;
        gap: 10px;
        padding: 10px;
    }
    
    .auth-buttons, .nav-buttons {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 6px 10px;
        font-size: 0.8rem;
        margin: 2px;
    }
    
    .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        font-size: 0.8rem;
    }
    
    .calendar-day {
        height: 45px;
        padding: 3px;
    }
    
    .day-number {
        font-size: 0.9rem;
    }
    
    .day-status {
        font-size: 0.6rem;
    }
    
    .stats {
        grid-template-columns: 1fr;
    }
    
    .attendance-buttons {
        flex-direction: column;
    }
    
    .date-inputs {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .date-inputs input, .date-inputs label {
        width: 100%;
        margin: 5px 0;
    }
    
    /* Fix logout button alignment */
    .nav-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    #logoutBtn {
        order: 4; /* Make logout last */
        margin-top: 5px;
        width: 100%;
    }
}

@media (max-width: 480px) {
    .calendar-day {
        height: 35px;
    }
    
    .day-number {
        font-size: 0.8rem;
    }
    
    .home-hero h1 {
        font-size: 1.8rem;
    }
    
    .home-hero p {
        font-size: 1rem;
    }
    
    .btn-track {
        padding: 10px 25px;
        font-size: 1rem;
    }
    .calendar-container {
    margin: 20px 0;
    overflow-x: auto; /* Add this line */
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    min-width: 700px; /* Add this line - prevents breaking */
}
#logoutBtn {
    background: #e74c3c;
    color: white;
    border: none;
    margin-left: 5px;
}

#logoutBtn:hover {
    background: #c0392b;
}
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo">
                <span>Attendance Tracker</span>
            </div>
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-login" id="loginBtn">Login</button>
                <button class="btn btn-signup" id="signupBtn">Sign Up</button>
            </div>
            <div class="nav-buttons" id="navButtons">
                <button class="btn btn-login" id="homeNavBtn">Home</button>
                <button class="btn btn-login" id="attendanceNavBtn">Attendance</button>
                <button class="btn btn-login" id="adminNavBtn">Admin</button>
                <button class="btn btn-signup" id="logoutBtn">Logout</button>
            </div>
        </header>
        
        <!-- Home Page -->
        <div class="page active-page" id="homePage">
            <div class="home-hero">
                <h1>Welcome to Attendance Tracker</h1>
                <p>Track your attendance easily. Stay on top of your records and achieve your goals.</p>
                <p><strong>Let's track your attendance!</strong></p>
                <button class="btn-track" id="startBtn">Start Tracking</button>
            </div>
        </div>
        
        <!-- Attendance Page -->
        <div class="page" id="attendancePage">
            <div class="date-display">
                <div class="current-date" id="currentDate">Sunday, February 8, 2026</div>
            </div>
            
            <!-- Date Range Selector -->
            
            <div class="date-range">
                <h3>View Attendance for Specific Date Range</h3>
                <div class="date-inputs">
                    <label>From:</label>
                    <input type="date" id="startDate" value="2026-01-28">
                    <label>To:</label>
                    <input type="date" id="endDate" value="2026-02-28">
                    <button class="btn btn-present" id="applyDateRange">Apply Range</button>
                    <button class="btn btn-absent" id="resetDateRange">Reset</button>
                    <br>
                    <label>Previous Period %:</label>
                    <input type="number" id="previousPercent" min="0" max="100" placeholder="e.g., 83" style="width: 80px;">
                    <button class="btn btn-purple" id="setPreviousPercent">Set Previous %</button>
                </div>
                <p id="rangeInfo" style="margin-top: 10px; color: #666;"></p>
            </div>
            
            <div class="attendance-buttons">
                <button class="btn btn-present" id="markPresent">Mark Present</button>
                <button class="btn btn-absent" id="markAbsent">Mark Absent</button>
            </div>
            
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2 id="calendarMonth">February 2026</h2>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="prevMonth">‚Üê Previous</button>
                        <button class="calendar-nav-btn" id="nextMonth">Next ‚Üí</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar">
                    <!-- Calendar will be filled by JavaScript -->
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <h3>Attendance %</h3>
                    <div class="stat-value percentage" id="attendancePercent">0%</div>
                    <p>Status: <span id="statusText">No Data</span></p>
                    <p id="dateRangeInfo">For current month</p>
                </div>
                <div class="stat-card">
                    <h3>Present Days</h3>
                    <div class="stat-value present-count" id="presentCount">0</div>
                    <p>Out of <span id="workingDays">0</span> working days</p>
                </div>
                <div class="stat-card">
                    <h3>Absent Days</h3>
                    <div class="stat-value absent-count" id="absentCount">0</div>
                    <p id="neededDays">Need 0 more days for 75%</p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-track" id="viewVisualBtn">View Visualization</button>
                <button class="btn btn-purple" onclick="viewAllNotes()">
                    üìù View My Absence Notes
                </button>
                <button class="btn btn-absent" id="goHome">Back to Home</button>
            </div>
        </div>
        
        <!-- Visualization Page -->
        <div class="page" id="visualizationPage">
            <div class="visualization-page">
                <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Your Attendance Analytics</h1>
                <p style="color: #a0a0a0; max-width: 600px; margin-bottom: 2rem;">Visual representation of your attendance performance.</p>
                
                <div class="attendance-ring">
                    <div class="ring-container" id="attendanceRing">
                        <div class="ring-spark"></div>
                    </div>
                    <div class="ring-inner">
                        <div class="percentage" id="visualPercentage">0%</div>
                        <div style="color: #a0a0a0; margin-top: 10px;">ATTENDANCE RATE</div>
                    </div>
                </div>
                
                <p style="margin-top: 2rem; color: #a0a0a0;">Your current attendance percentage visualized</p>
                
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; max-width: 600px;">
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <h3>Present Days</h3>
                        <div style="font-size: 1.8rem; font-weight: bold; color: #4cc9f0;" id="visPresent">0</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <h3>Absent Days</h3>
                        <div style="font-size: 1.8rem; font-weight: bold; color: #4cc9f0;" id="visAbsent">0</div>
                    </div>
                </div>
                
                <button class="btn-track" style="margin-top: 30px;" id="backToAttendance">Back to Attendance</button>
            </div>
        </div>
        
        <!-- Admin Page -->
        <div class="page" id="adminPage">
            <div class="admin-header">
                <h1>Admin Dashboard</h1>
            </div>
            
            <div class="admin-stats">
                <div class="admin-stat">
                    <h3>Active Users</h3>
                    <div class="stat-value" id="activeUsers">1</div>
                    <p>Currently logged in</p>
                </div>
                <div class="admin-stat">
                    <h3>Total Users</h3>
                    <div class="stat-value" id="totalUsers">1</div>
                    <p>Registered users</p>
                </div>
            </div>
            
            <div class="admin-panel">
                <h3>Set Working Days for Month</h3>
                <div style="margin: 15px 0;">
                    <label>Select Month:</label>
                    <select id="adminMonthSelect" style="padding: 8px; margin-left: 10px;">
                        <option value="0">January</option>
                        <option value="1" selected>February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                    </select>
                    <label style="margin-left: 20px;">Working Days:</label>
                    <input type="number" id="workingDaysInput" value="22" min="15" max="31" style="padding: 8px; margin-left: 10px; width: 80px;">
                    <button class="btn btn-present" id="setWorkingDays" style="margin-left: 20px;">Set Working Days</button>
                </div>
                <p id="workingDaysInfo" style="color: #666; margin-top: 10px;">Current: February 2026 - 22 working days</p>
                
                <h3 style="margin-top: 30px;">Add Holiday</h3>
                <div style="margin: 15px 0;">
                    <label>Date:</label>
                    <input type="date" id="holidayDate" style="padding: 8px; margin-left: 10px;">
                    <label style="margin-left: 20px;">Reason:</label>
                    <input type="text" id="holidayReason" placeholder="Festival/Event" style="padding: 8px; margin-left: 10px;">
                    <button class="btn btn-absent" id="addHoliday" style="margin-left: 20px;">Add Holiday</button>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-track" id="goHomeFromAdmin">Back to Home</button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer>
            <p>¬© 2026 Attendance Tracker</p>
            <p>Designed by <span class="designer">Sreejabura</span></p>
        </footer>
    </div>
    
    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h2>Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="Enter email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn-track" style="width: 100%;">Login</button>
            </form>
            <p style="text-align: center; margin-top: 15px; color: #666;">
                Need an account? <a href="#" id="showSignup" style="color: #4361ee;">Sign up</a>
            </p>
            <button class="btn" style="width: 100%; margin-top: 10px;" id="closeModal">Cancel</button>
        </div>
    </div>
    
    <!-- Signup Modal -->
    <div class="modal" id="signupModal">
        <div class="modal-content">
            <h2>Sign Up</h2>
            <form id="signupForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="Enter email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" placeholder="Create password" required>
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm password" required>
                </div>
                <button type="submit" class="btn-track" style="width: 100%;">Sign Up</button>
            </form>
            <p style="text-align: center; margin-top: 15px; color: #666;">
                Already have an account? <a href="#" id="showLogin" style="color: #4361ee;">Login</a>
            </p>
            <button class="btn" style="width: 100%; margin-top: 10px;" id="closeSignupModal">Cancel</button>
        </div>
    </div>

    <script>
        // CLEAN STATE MANAGEMENT
        let currentMonth = 1; // February
        let currentYear = 2026;
        let isLoggedIn = false;
        let currentUserEmail = null;
        let isAdmin = false;
        
        // Store data PER USER
        let usersData = {};
        let adminSettings = {
            workingDays: {
                '2026-1': 22, // February 2026: 22 working days
                '2026-0': 23, // January 2026: 23 working days
            },
            holidays: {
                '2026-1-8': 'Sunday',
                '2026-1-15': 'Sunday',
                '2026-1-22': 'Sunday',
                '2026-1-1': 'Sunday',
                '2026-1-14': '2nd Saturday',
                '2026-1-28': '4th Saturday'
            }
        };
        
        // Date range for custom view
                
        let dateRange = {
            start: new Date('2026-01-28'),
            end: new Date('2026-02-28'),
            active: false
        };
        
        let previousPeriodPercentage = 0;
        let rollingAverage = 0;
        let lastRangeEndDate = null;
        
        // Load saved data
        function loadData() {
            const saved = localStorage.getItem('attendanceAppData');
            if (saved) {
                const data = JSON.parse(saved);
                usersData = data.usersData || {};
                adminSettings = data.adminSettings || adminSettings;
            }
            
            
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                const user = JSON.parse(currentUser);
                currentUserEmail = user.email;
                isLoggedIn = true;
                isAdmin = user.email === 'admin@attendance.com';
                updateUIAfterLogin();
            }
        }
        
        // Save data
        function saveData() {
            const data = {
                usersData: usersData,
                adminSettings: adminSettings
            };
            localStorage.setItem('attendanceAppData', JSON.stringify(data));
            
            if (currentUserEmail) {
                const user = {
                    email: currentUserEmail,
                    isAdmin: isAdmin
                };
                localStorage.setItem('currentUser', JSON.stringify(user));
            }
        }
        
        // Get current user's attendance data
        function getUserData() {
            if (!currentUserEmail) return { present: [], absent: [], notes: {} };
            if (!usersData[currentUserEmail]) {
                usersData[currentUserEmail] = { present: [], absent: [], notes: {} };
            }
            return usersData[currentUserEmail];
        }
        
        // Save current user's data
        function saveUserData(data) {
            if (currentUserEmail) {
                usersData[currentUserEmail] = data;
                saveData();
            }
        }
        
        // Calculate holidays for a month
        function calculateHolidays(month, year) {
            const holidays = [];
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                const weekOfMonth = Math.ceil(day / 7);
                
                // Check if in admin holidays
                const holidayKey = `${year}-${month}-${day}`;
                if (adminSettings.holidays[holidayKey]) {
                    holidays.push(day);
                    continue;
                }
                
                // All Sundays
                if (dayOfWeek === 0) {
                    holidays.push(day);
                    continue;
                }
                
                // 2nd and 4th Saturdays
                if (dayOfWeek === 6 && (weekOfMonth === 2 || weekOfMonth === 4)) {
                    holidays.push(day);
                }
            }
            
            return holidays;
        }
        
        // DOM Elements
        const homePage = document.getElementById('homePage');
        const attendancePage = document.getElementById('attendancePage');
        const visualizationPage = document.getElementById('visualizationPage');
        const adminPage = document.getElementById('adminPage');
        const authButtons = document.getElementById('authButtons');
        const navButtons = document.getElementById('navButtons');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const startBtn = document.getElementById('startBtn');
        const homeNavBtn = document.getElementById('homeNavBtn');
        const attendanceNavBtn = document.getElementById('attendanceNavBtn');
        const adminNavBtn = document.getElementById('adminNavBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const goHome = document.getElementById('goHome');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const closeModal = document.getElementById('closeModal');
        const closeSignupModal = document.getElementById('closeSignupModal');
        const showSignup = document.getElementById('showSignup');
        const showLogin = document.getElementById('showLogin');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const markPresent = document.getElementById('markPresent');
        const markAbsent = document.getElementById('markAbsent');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const calendar = document.getElementById('calendar');
        const viewVisualBtn = document.getElementById('viewVisualBtn');
        const backToAttendance = document.getElementById('backToAttendance');
        const goHomeFromAdmin = document.getElementById('goHomeFromAdmin');
        const setWorkingDaysBtn = document.getElementById('setWorkingDays');
        const addHolidayBtn = document.getElementById('addHoliday');
        const applyDateRangeBtn = document.getElementById('applyDateRange');
        const resetDateRangeBtn = document.getElementById('resetDateRange');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateCalendar();
            updateStats();
            setupEventListeners();
            updateDateRangeInfo();
        });
        
        function setupEventListeners() {
            // Navigation
            startBtn.addEventListener('click', function() {
                if (!isLoggedIn) {
                    loginModal.classList.add('active');
                } else {
                    showPage('attendance');
                }
            });
            
            homeNavBtn.addEventListener('click', () => showPage('home'));
            attendanceNavBtn.addEventListener('click', () => showPage('attendance'));
            adminNavBtn.addEventListener('click', () => showPage('admin'));
            logoutBtn.addEventListener('click', logout);
            goHome.addEventListener('click', () => showPage('home'));
            goHomeFromAdmin.addEventListener('click', () => showPage('home'));
            viewVisualBtn.addEventListener('click', () => showPage('visualization'));
            backToAttendance.addEventListener('click', () => showPage('attendance'));
            
            // Modal controls
            loginBtn.addEventListener('click', () => loginModal.classList.add('active'));
            signupBtn.addEventListener('click', () => signupModal.classList.add('active'));
            closeModal.addEventListener('click', () => loginModal.classList.remove('active'));
            closeSignupModal.addEventListener('click', () => signupModal.classList.remove('active'));
            showSignup.addEventListener('click', function(e) {
                e.preventDefault();
                loginModal.classList.remove('active');
                signupModal.classList.add('active');
            });
            showLogin.addEventListener('click', function(e) {
                e.preventDefault();
                signupModal.classList.remove('active');
                loginModal.classList.add('active');
            });
            
            // Forms
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (email === 'admin@attendance.com' && password === 'admin123') {
                    // Admin login
                    currentUserEmail = email;
                    isLoggedIn = true;
                    isAdmin = true;
                    showNotification('Welcome Admin!', 'success');
                    loginModal.classList.remove('active');
                    updateUIAfterLogin();
                    showPage('admin');
                    saveData();
                } else if (email && password) {
                    // Regular user login
                    currentUserEmail = email;
                    isLoggedIn = true;
                    isAdmin = false;
                    showNotification('Login successful!', 'success');
                    loginModal.classList.remove('active');
                    updateUIAfterLogin();
                    showPage('attendance');
                    saveData();
                } else {
                    showNotification('Please enter email and password', 'error');
                }
            });
            
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const confirmPass = document.getElementById('confirmPassword').value;
                
                if (!email || !password || !confirmPass) {
                    showNotification('Please fill all fields', 'error');
                    return;
                }
                
                if (password !== confirmPass) {
                    showNotification('Passwords do not match', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showNotification('Password must be at least 6 characters', 'error');
                    return;
                }
                
                if (email === 'admin@attendance.com') {
                    showNotification('This email is reserved for admin', 'error');
                    return;
                }
                
                currentUserEmail = email;
                isLoggedIn = true;
                isAdmin = false;
                showNotification('Account created successfully!', 'success');
                signupModal.classList.remove('active');
                updateUIAfterLogin();
                showPage('attendance');
                saveData();
            });
            
            // Attendance buttons - FIXED
            markPresent.addEventListener('click', function() {
                if (!isLoggedIn) {
                    showNotification('Please login first', 'error');
                    return;
                }
                
                const today = new Date();
                const day = today.getDate();
                const userData = getUserData();
                const dateKey = `${currentYear}-${currentMonth}-${day}`;
                
                // Check if already marked
                if (userData.present.includes(dateKey)) {
                    showNotification('Already marked as Present for today', 'error');
                    return;
                }
                
                // Check if absent
                const absentIndex = userData.absent.indexOf(dateKey);
                if (absentIndex > -1) {
                    userData.absent.splice(absentIndex, 1);
                }
                
                // Add to present
                if (!userData.present.includes(dateKey)) {
                    userData.present.push(dateKey);
                }
                
                saveUserData(userData);
                updateCalendar();
                updateStats();
                showNotification('Marked as Present for today', 'success');
            });
            
            markAbsent.addEventListener('click', function() {
                if (!isLoggedIn) {
                    showNotification('Please login first', 'error');
                    return;
                }
                
                const today = new Date();
                const day = today.getDate();
                const userData = getUserData();
                const dateKey = `${currentYear}-${currentMonth}-${day}`;
                
                // Check if already marked
                if (userData.absent.includes(dateKey)) {
                    showNotification('Already marked as Absent for today', 'error');
                    return;
                }
                
                // Check if present
                const presentIndex = userData.present.indexOf(dateKey);
                if (presentIndex > -1) {
                    userData.present.splice(presentIndex, 1);
                }
                
                // Add to absent
                if (!userData.absent.includes(dateKey)) {
                    userData.absent.push(dateKey);
                }
                
                // Ask for note
                const note = prompt('Reason for absence (optional):');
                if (note !== null && note.trim()) {
                    if (!userData.notes) userData.notes = {};
                    userData.notes[dateKey] = note.trim();
                }
                
                saveUserData(userData);
                updateCalendar();
                updateStats();
                showNotification('Marked as Absent for today', 'success');
            });
            
            // Calendar navigation
            prevMonthBtn.addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateCalendar();
                updateStats();
            });
            
            nextMonthBtn.addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                updateCalendar();
                updateStats();
            });
            
            // Admin functions
            setWorkingDaysBtn.addEventListener('click', function() {
                const month = parseInt(document.getElementById('adminMonthSelect').value);
                const days = parseInt(document.getElementById('workingDaysInput').value);
                
                if (days < 15 || days > 31) {
                    showNotification('Working days must be between 15-31', 'error');
                    return;
                }
                
                const key = `${currentYear}-${month}`;
                adminSettings.workingDays[key] = days;
                saveData();
                showNotification(`Working days set for ${getMonthName(month)} ${currentYear}: ${days} days`, 'success');
                document.getElementById('workingDaysInfo').textContent = 
                    `Current: ${getMonthName(month)} ${currentYear} - ${days} working days`;
            });
            
            addHolidayBtn.addEventListener('click', function() {
                const dateStr = document.getElementById('holidayDate').value;
                const reason = document.getElementById('holidayReason').value;
                
                if (!dateStr || !reason) {
                    showNotification('Please select date and enter reason', 'error');
                    return;
                }
                
                const date = new Date(dateStr);
                const year = date.getFullYear();
                const month = date.getMonth();
                const day = date.getDate();
                
                const key = `${year}-${month}-${day}`;
                adminSettings.holidays[key] = reason;
                saveData();
                
                // Update calendar if we're viewing that month
                if (month === currentMonth && year === currentYear) {
                    updateCalendar();
                    updateStats();
                }
                
                showNotification(`Holiday added: ${dateStr} - ${reason}`, 'success');
                document.getElementById('holidayDate').value = '';
                document.getElementById('holidayReason').value = '';
            });
            
            // Date range functions
            applyDateRangeBtn.addEventListener('click', function() {
                const start = new Date(startDateInput.value);
                const end = new Date(endDateInput.value);
                
                if (start > end) {
                    showNotification('Start date must be before end date', 'error');
                    return;
                }
                
                dateRange.start = start;
                dateRange.end = end;
                dateRange.active = true;
                updateStats();
                updateDateRangeInfo();
                showNotification(`Showing attendance from ${formatDate(start)} to ${formatDate(end)}`, 'info');
            });
            
                                   resetDateRangeBtn.addEventListener('click', function() {
                dateRange.active = false;
                // Reset rolling average tracking
                previousPeriodPercentage = 0;
                rollingAverage = 0;
                lastRangeEndDate = null;
                updateStats();
                updateDateRangeInfo();
                showNotification('Showing attendance for current month', 'info');
            });
        }
                    // Manual previous percentage input
            document.getElementById('setPreviousPercent').addEventListener('click', function() {
                const prevPercentInput = document.getElementById('previousPercent');
                const prevPercent = parseInt(prevPercentInput.value);
                
                if (isNaN(prevPercent) || prevPercent < 0 || prevPercent > 100) {
                    showNotification('Please enter a valid percentage (0-100)', 'error');
                    return;
                }
                
                previousPeriodPercentage = prevPercent;
                showNotification(`Previous period percentage set to ${prevPercent}%`, 'success');
                
                // If date range is active, recalculate rolling average
                if (dateRange.active) {
                    updateStats();
                }
            });
                        // Allow Enter key to set previous percentage
            document.getElementById('previousPercent').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('setPreviousPercent').click();
                }
            });
        
        function showPage(page) {
            homePage.classList.remove('active-page');
            attendancePage.classList.remove('active-page');
            visualizationPage.classList.remove('active-page');
            adminPage.classList.remove('active-page');
            
            if (page === 'home') {
                homePage.classList.add('active-page');
            } else if (page === 'attendance') {
                attendancePage.classList.add('active-page');
                updateCalendar();
                updateStats();
            } else if (page === 'visualization') {
                visualizationPage.classList.add('active-page');
                updateVisualization();
            } else if (page === 'admin') {
                if (!isAdmin) {
                    showNotification('Admin access required', 'error');
                    showPage('attendance');
                    return;
                }
                adminPage.classList.add('active-page');
                updateAdminStats();
            }
        }
        
        function updateUIAfterLogin() {
            authButtons.style.display = 'none';
            navButtons.style.display = 'flex';
            adminNavBtn.style.display = isAdmin ? 'block' : 'none';
        }
        
        function logout() {
            isLoggedIn = false;
            currentUserEmail = null;
            isAdmin = false;
            authButtons.style.display = 'flex';
            navButtons.style.display = 'none';
            localStorage.removeItem('currentUser');
            showPage('home');
            showNotification('Logged out successfully', 'success');
        }
        

            
        function updateCalendar() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Clear calendar
            calendar.innerHTML = '';
            

    // Add day headers
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    days.forEach(day => {
        const dayEl = document.createElement('div');
        dayEl.className = 'day-header';
        dayEl.textContent = day;
        calendar.appendChild(dayEl);
    });
    
    // Get first day of month
    const firstDay = new Date(currentYear, currentMonth, 1);
    const startDay = firstDay.getDay();
    
    // Get days in month
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = new Date();
    const userData = getUserData();
    const holidays = calculateHolidays(currentMonth, currentYear);
    
    // Add empty cells for days before first day
    for (let i = 0; i < startDay; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day';
        calendar.appendChild(empty);
    }
    
    // Add days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.dataset.day = day;
        
        // Check if today
        if (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
            dayEl.classList.add('today');
        }
        
        // Check if holiday
        if (holidays.includes(day)) {
            dayEl.classList.add('holiday');
        }
        
        // Check if marked
        const dateKey = `${currentYear}-${currentMonth}-${day}`;
        if (userData.present.includes(dateKey)) {
            dayEl.classList.add('present');
        } else if (userData.absent.includes(dateKey)) {
            dayEl.classList.add('absent');
        }
        
        // Add day number
        const dayNum = document.createElement('div');
        dayNum.className = 'day-number';
        dayNum.textContent = day;
        dayEl.appendChild(dayNum);
        
        // Add status
        const status = document.createElement('div');
        status.className = 'day-status';
        
        if (dayEl.classList.contains('present')) {
            status.textContent = 'Present';
            status.style.color = '#4CAF50';
        } else if (dayEl.classList.contains('absent')) {
            status.textContent = 'Absent';
            status.style.color = '#f44336';
            // Show note icon if note exists
            if (userData.notes && userData.notes[dateKey]) {
                status.textContent += ' üìù';
                dayEl.title = `Note: ${userData.notes[dateKey]}`;
            }
        } else if (dayEl.classList.contains('holiday')) {
            const date = new Date(currentYear, currentMonth, day);
            if (date.getDay() === 0) {
                status.textContent = 'Sunday';
            } else if (date.getDay() === 6) {
                const week = Math.ceil(day / 7);
                status.textContent = week === 2 ? '2nd Sat' : '4th Sat';
            } else {
                const holidayKey = `${currentYear}-${currentMonth}-${day}`;
                status.textContent = adminSettings.holidays[holidayKey] || 'Holiday';
            }
            status.style.color = '#ff9800';
        }
        
        dayEl.appendChild(status);
        
        
                // Add click event for calendar days
                
                if (isLoggedIn) {
                    dayEl.addEventListener('click', function() {
                        // Check if future date
                        const clickedDate = new Date(currentYear, currentMonth, day);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        if (clickedDate > today) {
                            showNotification('Cannot mark attendance for future dates!', 'error');
                            return;
                        }
                        
                        if (holidays.includes(day)) {
                            showNotification('Cannot mark attendance on holidays', 'warning');
                            return;
                        }
                        
                        const userData = getUserData();
                        const dateKey = `${currentYear}-${currentMonth}-${day}`;
                        
                        const isPresent = userData.present.includes(dateKey);
                        const isAbsent = userData.absent.includes(dateKey);
                        
                        // Show options dialog based on current status
                        let action;
                        if (isPresent) {
                            action = prompt(
                                `üìÖ Day ${day} is marked as PRESENT\n\n` +
                                `What would you like to do?\n\n` +
                                `1. Change to Absent\n` +
                                `2. Remove mark\n` +
                                `3. Cancel\n\n` +
                                `Enter 1, 2, or 3:`,
                                '3'
                            );
                        } else if (isAbsent) {
                            action = prompt(
                                `üìÖ Day ${day} is marked as ABSENT\n\n` +
                                `What would you like to do?\n\n` +
                                `1. Change to Present\n` +
                                `2. Remove mark\n` +
                                `3. Cancel\n\n` +
                                `Enter 1, 2, or 3:`,
                                '3'
                            );
                        } else {
                            action = prompt(
                                `üìÖ Day ${day} is NOT MARKED\n\n` +
                                `What would you like to do?\n\n` +
                                `1. Mark as Present\n` +
                                `2. Mark as Absent\n` +
                                `3. Cancel\n\n` +
                                `Enter 1, 2, or 3:`,
                                '3'
                            );
                        }
                        
                        // Check if user pressed Cancel or closed the prompt
                        if (action === null) {
                            // User pressed Cancel button
                            showNotification('Action cancelled', 'info');
                            return;
                        }
                        
                        // Trim the input
                        action = action.trim();
                        
                        // Check if empty
                        if (action === '') {
                            showNotification('No action selected', 'info');
                            return;
                        }
                        
                        // Check if it's "3" or "cancel" (case insensitive)
                        if (action === '3' || action.toLowerCase() === 'cancel') {
                            showNotification('Action cancelled', 'info');
                            return;
                        }
                        
                        // Convert to number for comparison
                        let actionNum;
                        if (action === '1' || action === '2') {
                            actionNum = parseInt(action);
                        } else {
                            showNotification('Invalid choice. Please enter 1, 2, or 3', 'error');
                            return;
                        }
                        
                        // Handle the action based on current status
                        if (isPresent) {
                            // Currently marked as Present
                            if (actionNum === 1) {
                                // Change to Absent
                                userData.present = userData.present.filter(d => d !== dateKey);
                                userData.absent.push(dateKey);
                                
                                // Ask for note
                                const note = prompt('Reason for absence (optional):\n\nPress OK with empty to skip');
                                if (note !== null && note.trim() !== '') {
                                    if (!userData.notes) userData.notes = {};
                                    userData.notes[dateKey] = note.trim();
                                }
                                
                                showNotification(`‚úÖ Day ${day} changed to Absent`, 'success');
                            } else if (actionNum === 2) {
                                // Remove mark
                                userData.present = userData.present.filter(d => d !== dateKey);
                                showNotification(`‚ÑπÔ∏è Present mark removed for day ${day}`, 'info');
                            }
                        } else if (isAbsent) {
                            // Currently marked as Absent
                            if (actionNum === 1) {
                                // Change to Present
                                userData.absent = userData.absent.filter(d => d !== dateKey);
                                userData.present.push(dateKey);
                                
                                // Remove note if exists
                                if (userData.notes && userData.notes[dateKey]) {
                                    delete userData.notes[dateKey];
                                }
                                
                                showNotification(`‚úÖ Day ${day} changed to Present`, 'success');
                            } else if (actionNum === 2) {
                                // Remove mark
                                userData.absent = userData.absent.filter(d => d !== dateKey);
                                
                                // Remove note if exists
                                if (userData.notes && userData.notes[dateKey]) {
                                    delete userData.notes[dateKey];
                                }
                                
                                showNotification(`‚ÑπÔ∏è Absent mark removed for day ${day}`, 'info');
                            }
                        } else {
                            // Not marked yet
                            if (actionNum === 1) {
                                // Mark as Present
                                userData.present.push(dateKey);
                                showNotification(`‚úÖ Day ${day} marked as Present`, 'success');
                            } else if (actionNum === 2) {
                                // Mark as Absent
                                userData.absent.push(dateKey);
                                
                                // Ask for note
                                const note = prompt('Reason for absence (optional):\n\nPress OK with empty to skip');
                                if (note !== null && note.trim() !== '') {
                                    if (!userData.notes) userData.notes = {};
                                    userData.notes[dateKey] = note.trim();
                                }
                                
                                showNotification(`‚úÖ Day ${day} marked as Absent`, 'success');
                            }
                        }
                        
                        saveUserData(userData);
                        updateCalendar();
                        updateStats();
                    });
                }
        calendar.appendChild(dayEl);
    }
}
        
        
                            function updateStats() {
            if (!isLoggedIn) return;
            
            const userData = getUserData();
            let presentCount = 0;
            let absentCount = 0;
            let totalWorkingDays = 0;
            
            const startDate = dateRange.active ? dateRange.start : new Date(currentYear, currentMonth, 1);
            const endDate = dateRange.active ? dateRange.end : new Date(currentYear, currentMonth + 1, 0);
            
            // Calculate for date range
            let current = new Date(startDate);
            while (current <= endDate) {
                const year = current.getFullYear();
                const month = current.getMonth();
                const day = current.getDate();
                const dateKey = `${year}-${month}-${day}`;
                
                // Check if holiday
                const holidays = calculateHolidays(month, year);
                if (holidays.includes(day)) {
                    current.setDate(current.getDate() + 1);
                    continue;
                }
                
                totalWorkingDays++;
                
                if (userData.present.includes(dateKey)) {
                    presentCount++;
                } else if (userData.absent.includes(dateKey)) {
                    absentCount++;
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            // Calculate current period percentage
            let currentPercentage = 0;
            if (totalWorkingDays > 0) {
                currentPercentage = Math.round((presentCount / totalWorkingDays) * 100);
            }
            
            // Check if we should calculate rolling average
        
            // Check if we should calculate rolling average
            let shouldCalculateRollingAverage = false;
            let useManualPreviousPercent = false;
            
            // Check if user manually entered a previous percentage
            const prevPercentInput = document.getElementById('previousPercent');
            const manualPrevPercent = parseInt(prevPercentInput.value);
            
            if (!isNaN(manualPrevPercent) && manualPrevPercent >= 0 && manualPrevPercent <= 100) {
                // User manually entered a percentage
                previousPeriodPercentage = manualPrevPercent;
                useManualPreviousPercent = true;
                shouldCalculateRollingAverage = true;
            } else if (dateRange.active && lastRangeEndDate) {
                // Auto-detect consecutive ranges
                const nextDay = new Date(lastRangeEndDate);
                nextDay.setDate(nextDay.getDate() + 1);
                
                if (formatDate(startDate) === formatDate(nextDay)) {
                    shouldCalculateRollingAverage = true;
                }
            }
            // Calculate rolling average
            if (shouldCalculateRollingAverage) {
                rollingAverage = Math.round((previousPeriodPercentage + currentPercentage) / 2);
            } else {
                rollingAverage = currentPercentage;
            }
            
            // Save current values for next time
            previousPeriodPercentage = currentPercentage;
            lastRangeEndDate = new Date(endDate);
            
            // Update display
            document.getElementById('attendancePercent').textContent = currentPercentage + '%';
            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('workingDays').textContent = totalWorkingDays;
            
            // Calculate needed days for 75%
            let needed = 0;
            if (currentPercentage < 75 && totalWorkingDays > 0) {
                needed = Math.ceil((0.75 * totalWorkingDays - presentCount) / 1);
                needed = Math.max(0, needed);
            }
            document.getElementById('neededDays').textContent = `Need ${needed} more days for 75%`;
            
            // Status text
            let status = 'No Data';
            if (totalWorkingDays > 0) {
                if (currentPercentage >= 90) status = 'Excellent';
                else if (currentPercentage >= 80) status = 'Good';
                else if (currentPercentage >= 75) status = 'Satisfactory';
                else if (presentCount > 0) status = 'Needs Improvement';
            }
            
            // Add rolling average to status if applicable
            if (shouldCalculateRollingAverage && rollingAverage !== currentPercentage) {
                status += ` | Rolling: ${rollingAverage}%`;
            }
            
            document.getElementById('statusText').textContent = status;
            
            // Update date range info
            const dateRangeInfo = document.getElementById('dateRangeInfo');
            if (dateRange.active) {
                if (shouldCalculateRollingAverage && rollingAverage !== currentPercentage) {
                    dateRangeInfo.textContent = `Rolling Average: ${rollingAverage}% (Current: ${currentPercentage}%)`;
                } else {
                    dateRangeInfo.textContent = `Current: ${currentPercentage}%`;
                }
            } else {
                dateRangeInfo.textContent = `Current: ${currentPercentage}%`;
            }
            
            // Update visualization
            updateVisualization();
        }
        
        
        function updateVisualization() {
            const percent = document.getElementById('attendancePercent').textContent;
            const percentage = parseInt(percent) || 0;
            
            document.getElementById('visualPercentage').textContent = percentage + '%';
            document.getElementById('visPresent').textContent = document.getElementById('presentCount').textContent;
            document.getElementById('visAbsent').textContent = document.getElementById('absentCount').textContent;
            
            // Update ring
            const ring = document.getElementById('attendanceRing');
            ring.style.background = `conic-gradient(
                #4cc9f0 0% ${percentage}%,
                #3a0ca3 ${percentage}% 100%
            )`;
        }
        
        function updateAdminStats() {
            const userCount = Object.keys(usersData).length;
            document.getElementById('totalUsers').textContent = userCount;
            document.getElementById('activeUsers').textContent = isLoggedIn ? 1 : 0;
        }
        
        
                function updateDateRangeInfo() {
            const rangeInfo = document.getElementById('rangeInfo');
            const dateRangeInfo = document.getElementById('dateRangeInfo');
            
            if (dateRange.active) {
                rangeInfo.textContent = `Showing attendance from ${formatDate(dateRange.start)} to ${formatDate(dateRange.end)}`;
                // The actual percentage will be shown in updateStats()
            } else {
                rangeInfo.textContent = 'Select date range to view attendance for specific period';
            }
        }
        
        function viewAllNotes() {
            if (!isLoggedIn) {
                showNotification('Please login first', 'error');
                return;
            }
            
            const userData = getUserData();
            if (!userData.notes || Object.keys(userData.notes).length === 0) {
                showNotification('No absence notes saved yet.', 'info');
                return;
            }
            
            let notesText = '=== YOUR ABSENCE NOTES ===\n\n';
            for (const dateKey in userData.notes) {
                const [year, month, day] = dateKey.split('-').map(Number);
                const date = new Date(year, month, day);
                notesText += `üìÖ ${date.toDateString()}\n`;
                notesText += `üìù ${userData.notes[dateKey]}\n`;
                notesText += '‚îÄ'.repeat(30) + '\n';
            }
            
            alert(notesText);
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        function getMonthName(month) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return monthNames[month];
        }
        
                // ... your other functions ...

        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
     // <-- This should be the LAST closing brace in your script
    </script>
</body>
</html>